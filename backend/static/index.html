<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Weit - Premium Trend Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        body { background: #F5F1E8; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* Жесткий фикс высоты для графиков */
        .chart-container {
            position: relative;
            height: 300px !important;
            width: 100%;
        }

        .stat-card { background: white; border: 2px solid #E8E3D8; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #C9A875, #B8976A); color: white; }
        
        /* Ограничиваем рост области результата */
        #resultArea { min-height: 200px; }
        
        .prose table { width: 100%; border-collapse: collapse; background: white; }
        .prose th { background: #C9A875; color: white; padding: 10px; }
        .prose td { border: 1px solid #E8E3D8; padding: 10px; color: #4A423C; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-4xl font-black" style="color: #2C2420;">THE <span style="color: #C9A875;">WEIT</span></h1>
            <p id="timeLabel" class="text-xs text-slate-400"></p>
        </div>

        <div class="bg-white p-6 rounded-2xl mb-8 shadow-sm border-2 border-[#E8E3D8]">
            <div class="flex flex-col md:flex-row gap-4">
                <input id="urlInput" type="text" class="flex-1 p-4 rounded-xl border-2 border-[#E8E3D8] outline-none" placeholder="Вставьте ссылку...">
                <button id="runBtn" onclick="analyze()" class="btn-primary px-10 py-4 rounded-xl font-bold">▶ RUN ANALYSIS</button>
            </div>
            <div id="progressContainer" class="hidden mt-4">
                <div class="w-full bg-[#E8E3D8] h-1.5 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-[#C9A875] transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card p-6 rounded-2xl"><p class="text-xs font-bold text-[#8B7355] uppercase">Viral Score</p><p id="viralScore" class="text-4xl font-black text-[#C9A875]">—</p></div>
            <div class="stat-card p-6 rounded-2xl"><p class="text-xs font-bold text-[#8B7355] uppercase">Niche</p><p id="hotCategory" class="text-lg font-bold">—</p></div>
            <div class="stat-card p-6 rounded-2xl"><p class="text-xs font-bold text-[#8B7355] uppercase">Engagement</p><p id="engagement" class="text-4xl font-black text-[#B8976A]">—</p></div>
            <div class="stat-card p-6 rounded-2xl"><p class="text-xs font-bold text-[#8B7355] uppercase">Posts</p><p id="postsCount" class="text-4xl font-black text-[#8B7355]">—</p></div>
        </div>

        <div id="chartsSection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 hidden">
            <div class="stat-card p-4 rounded-2xl chart-container"><canvas id="engagementChart"></canvas></div>
            <div class="stat-card p-4 rounded-2xl chart-container"><canvas id="categoryChart"></canvas></div>
        </div>

        <div class="bg-white rounded-2xl border-2 border-[#E8E3D8] overflow-hidden shadow-sm">
            <div id="resultArea" class="p-6 md:p-8 prose prose-slate max-w-none">
                <p class="text-center text-slate-400">Ожидание запроса...</p>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        async function analyze() {
            const url = document.getElementById('urlInput').value.trim();
            if(!url) return;

            const btn = document.getElementById('runBtn');
            const resArea = document.getElementById('resultArea');
            const prog = document.getElementById('progressBar');
            
            btn.disabled = true;
            document.getElementById('progressContainer').classList.remove('hidden');
            resArea.innerHTML = '<p class="text-center">Анализируем тренды...</p>';
            prog.style.width = '30%';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                
                prog.style.width = '100%';
                // ОЧИЩАЕМ и выводим результат
                resArea.innerHTML = marked.parse(data.result);
                
                const v = data.result.match(/Viral Score\s*\|\s*([\d/]+)/);
                const c = data.result.match(/Товарная ниша\s*\|\s*([^|\n]+)/);
                const e = data.result.match(/Средняя вовлеченность\s*\|\s*([\d.]+)%/);
                const p = data.result.match(/Постов проанализировано\s*\|\s*(\d+)/);

                if(v) document.getElementById('viralScore').innerText = v[1];
                if(c) document.getElementById('hotCategory').innerText = c[1];
                if(e) document.getElementById('engagement').innerText = e[1] + '%';
                if(p) document.getElementById('postsCount').innerText = p[1];

                document.getElementById('chartsSection').classList.remove('hidden');
                updateCharts();
            } catch (e) {
                resArea.innerHTML = 'Ошибка. Проверьте соединение.';
            } finally {
                btn.disabled = false;
                setTimeout(() => document.getElementById('progressContainer').classList.add('hidden'), 1000);
            }
        }

        function updateCharts() {
            // Удаляем старые графики перед созданием новых
            if(charts.eng) charts.eng.destroy();
            if(charts.cat) charts.cat.destroy();

            charts.eng = new Chart(document.getElementById('engagementChart'), {
                type: 'line',
                data: { labels: ['1','2','3','4','5'], datasets: [{ label: 'Trend', data: [2,5,3,8,4], borderColor: '#C9A875', tension: 0.4 }] },
                options: { maintainAspectRatio: false, responsive: true }
            });

            charts.cat = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: { labels: ['A','B','C'], datasets: [{ data: [40,30,30], backgroundColor: ['#C9A875','#B8976A','#E8E3D8'] }] },
                options: { maintainAspectRatio: false, responsive: true }
            });
        }
    </script>
</body>
</html>
