import os
import google.generativeai as genai
from google.generativeai.types import Tool

def analyze_trend(data):
    api_key = os.environ.get("GOOGLE_API_KEY")
    if not api_key: return "–û–®–ò–ë–ö–ê: API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω."

    try:
        genai.configure(api_key=api_key)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ–∏—Å–∫–∞ Google –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ò–ò –≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π YouTube –∏ Google Trends –Ω–∞ —Ç–µ–∫—É—â—É—é —Å–µ–∫—É–Ω–¥—É
        tools = [Tool(google_search_retrieval={})]
        
        # –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ (1.5 Flash - —Å–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –¥–ª—è –ø–æ–∏—Å–∫–∞)
        model = genai.GenerativeModel(
            model_name='gemini-1.5-flash',
            tools=tools
        )
        
        # –¢–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–®–∞–≥ 6 + –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
        prompt = f"""
        –¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ The Weit. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "{data}"
        
        –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û–ò–°–ö–ê:
        1. –°–æ–±–µ—Ä–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ 50 –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º –≤–∏–¥–µ–æ (YouTube) –∏ —Å–∏–≥–Ω–∞–ª–∞–º —Å–ø—Ä–æ—Å–∞ (Google Trends).
        2. –ü—Ä–∏–≤–µ–¥–∏ –∏—Ö –∫ —Ñ–æ—Ä–º–∞—Ç—É: {{source, topic, signal, metrics, url, date}}.
        3. –í—ã–ø–æ–ª–Ω–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é: —É–¥–∞–ª–∏ –¥—É–±–ª–∏, –æ—Ç—Å–µ–π —à—É–º, –≤—ã–±–µ—Ä–∏ —Ç–æ–ø-5 –Ω–∞–∏–±–æ–ª–µ–µ –≤–∏—Ä–∞–ª—å–Ω—ã—Ö –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞.
        4. –°–¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö.

        –û–¢–ß–ï–¢ –í–´–î–ê–ô –°–¢–†–û–ì–û –í –≠–¢–û–ú –§–û–†–ú–ê–¢–ï:

        ### üìä –¢–ê–ë–õ–ò–¶–ê –ú–ï–¢–†–ò–ö
        | Metric | Value | Comparison |
        | :--- | :--- | :--- |
        | Viral Score | [0-10] | [–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –Ω–æ—Ä–º–æ–π] |
        | Product Niche | [–ù–∏—à–∞] | [–°–∏–≥–Ω–∞–ª —Å–ø—Ä–æ—Å–∞] |
        | Engagement | [0.0]% | [Vs Market Avg: 5.2%] |
        | Data Sources | 50 | [Verified Links] |

        ### üé¨ –†–ê–ó–ë–û–† –°–¢–†–ê–¢–ï–ì–ò–ò (TOP-5)
        **–°—é–∂–µ—Ç:** ...
        **–°–º—ã—Å–ª–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:** ...
        **–î—Ä–∞–º–∞—Ç—É—Ä–≥–∏—è:** (–∞–Ω–∞–ª–∏–∑ —É–¥–µ—Ä–∂–∞–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è)
        **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ...
        **–í–∏–¥–µ–æ—Ä—è–¥:** ...
        **–û–∑–≤—É—á–∫–∞:** ...
        **–î—Ä—É–≥–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** ...
        **–ö–ª—é—á–µ–≤–æ–π —Ñ–∞–∫—Ç–æ—Ä —É—Å–ø–µ—Ö–∞:** ...
        **–í—ã–≤–æ–¥:** ...

        ---APPLIED_MATERIAL---
        **–†–ï–ê–õ–¨–ù–´–ï –ò–°–¢–û–ß–ù–ò–ö–ò –ê–ù–ê–õ–ò–ó–ê (–°–°–´–õ–ö–ò):**
        (–í—ã–≤–µ–¥–∏ —Å–ø–∏—Å–æ–∫ –∏–∑ 5-10 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ YouTube –∏–∑ —Ç–µ—Ö 50, —á—Ç–æ —Ç—ã –Ω–∞—à–µ–ª)
        """
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–∏—Å–∫–∞
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"System Error: {str(e)}"