import os
import google.generativeai as genai
import time
import scrapetube

def analyze_trend(data):
    api_key = os.environ.get("GOOGLE_API_KEY")
    if not api_key: 
        return "–û–®–ò–ë–ö–ê: API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω."
    
    try:
        # 1. –°–ë–û–† –†–ï–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–• –° YOUTUBE
        print(f"üîé –ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: {data}")
        search_results = scrapetube.get_search(data, limit=10)
        video_links = []
        for video in search_results:
            video_links.append(f"https://www.youtube.com/watch?v={video['videoId']}")
        
        if not video_links:
            return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∏–¥–µ–æ –ø–æ –¥–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞."

        # 2. –ù–ê–°–¢–†–û–ô–ö–ê GEMINI
        genai.configure(api_key=api_key)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ—é –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
        model_id = 'models/gemini-flash-latest'
        model = genai.GenerativeModel(model_name=model_id)
        
        links_str = "\n".join(video_links)
        
        # 3. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ü–†–û–ú–ü–¢–ê –ü–û –¢–í–û–ï–ô –°–¢–†–£–ö–¢–£–†–ï
        prompt = f"""
–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è The Weit. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ YouTube.

–ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –≠–¢–ò –í–ò–î–ï–û:
{links_str}

–í–´–î–ê–ô –û–¢–ß–ï–¢ –°–¢–†–û–ì–û –í –≠–¢–û–ú –§–û–†–ú–ê–¢–ï:

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –ó–Ω–∞—á–µ–Ω–∏–µ |
| :--- | :--- |
| Viral Score | [0-10] |
| –¢–æ–≤–∞—Ä–Ω–∞—è –Ω–∏—à–∞ | [–ù–∞–∑–≤–∞–Ω–∏–µ] |
| –°—Ä–µ–¥–Ω—è—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å | [0.0]% |
| –ü–æ—Å—Ç–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ | 10 |

### üé¨ –£–°–ü–ï–®–ù–´–ï –†–û–õ–ò–ö–ò –•–ê–†–ê–ö–¢–ï–†–ò–ó–£–Æ–¢–°–Ø:
**–°—é–∂–µ—Ç:** [–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä]
**–°–º—ã—Å–ª–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:** [–ö–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏]
**–î—Ä–∞–º–∞—Ç—É—Ä–≥–∏—è:** [–ö–∞–∫ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ, –∑–∞—Ü–µ–ø–∫–∏]
**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** [–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è]
**–í–∏–¥–µ–æ—Ä—è–¥:** [–°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞, –º–æ–Ω—Ç–∞–∂]
**–û–∑–≤—É—á–∫–∞:** [–¢–æ–Ω, –º—É–∑—ã–∫–∞, –ø–æ–¥–∞—á–∞]
**–î—Ä—É–≥–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** [–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ–∏—à–∫–∏]
**–ö–ª—é—á–µ–≤–æ–π —Ñ–∞–∫—Ç–æ—Ä —É—Å–ø–µ—Ö–∞:** [–ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–¥–µ–ª–∞–ª–æ –∏—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏]

**–í—ã–≤–æ–¥:** [–ë–∏–∑–Ω–µ—Å-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]

---APPLIED_MATERIAL---
### üìÇ –ü–†–ò–ö–õ–ê–î–ù–û–ô –ú–ê–¢–ï–†–ò–ê–õ:
–í–æ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä—ã–µ –ª–µ–≥–ª–∏ –≤ –æ—Å–Ω–æ–≤—É –∞–Ω–∞–ª–∏–∑–∞:
{links_str}
"""
        
        # 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø
        print(f"üöÄ –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ {model_id}...")
        response = model.generate_content(prompt)
        
        if response and response.text:
            return response.text
            
    except Exception as e:
        error_msg = str(e)
        if "429" in error_msg:
            return "‚ö†Ô∏è –õ–∏–º–∏—Ç—ã API –≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."
        return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {error_msg}"